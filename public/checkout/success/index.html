<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Who Is Wrong?</title>
    <meta name="description" content="Your payment was successful. Create an account to keep your purchase!">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öñÔ∏è</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['Oswald', 'sans-serif'],
                        'sans': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: white;
        }
        
        h1, h2, h3, .font-display {
            font-family: 'Oswald', sans-serif;
        }
        
        .glass-panel {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .success-animation {
            animation: successPop 0.5s ease-out forwards;
        }
        
        @keyframes successPop {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .confetti {
            animation: confettiDrop 1s ease-out forwards;
        }
        
        @keyframes confettiDrop {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
            100% { transform: translateY(0) rotate(360deg); opacity: 1; }
        }
        
        input:focus {
            outline: none;
        }
        
        @media (max-width: 640px) {
            button, input {
                min-height: 48px;
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    
    <div class="max-w-md w-full">
        <div class="glass-panel p-6 sm:p-8 rounded-2xl text-center">
            
            <!-- Success Icon -->
            <div class="success-animation mb-4 sm:mb-6">
                <div class="inline-flex items-center justify-center w-20 h-20 sm:w-24 sm:h-24 bg-green-500/20 rounded-full">
                    <span class="text-5xl sm:text-6xl">üéâ</span>
                </div>
            </div>
            
            <!-- Confetti decorations -->
            <div class="flex justify-center gap-4 mb-4 sm:mb-6">
                <span class="confetti text-xl sm:text-2xl" style="animation-delay: 0.1s;">‚ú®</span>
                <span class="confetti text-xl sm:text-2xl" style="animation-delay: 0.2s;">üéä</span>
                <span class="confetti text-xl sm:text-2xl" style="animation-delay: 0.3s;">‚≠ê</span>
                <span class="confetti text-xl sm:text-2xl" style="animation-delay: 0.4s;">üéâ</span>
            </div>
            
            <!-- Title -->
            <h1 class="font-display text-2xl sm:text-3xl font-bold mb-3 sm:mb-4 text-green-400">
                Payment Successful!
            </h1>
            
            <!-- Details box - What they bought -->
            <div id="detailsBox" class="bg-gray-800/50 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6 text-left">
                <div class="flex items-center gap-3 text-green-400">
                    <i class="fas fa-check-circle"></i>
                    <span id="accessDetails" class="text-sm sm:text-base">Loading purchase details...</span>
                </div>
            </div>
            
            <!-- State: Already logged in (auto-save purchase) -->
            <div id="loggedInState" class="hidden">
                <p id="savingMessage" class="text-gray-300 text-base sm:text-lg mb-4 sm:mb-6">
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    Saving your purchase to your account...
                </p>
                
                <a href="/" id="startJudgingBtn" class="hidden inline-flex items-center justify-center gap-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 sm:py-4 px-6 sm:px-8 rounded-xl text-base sm:text-lg transition">
                    <i class="fas fa-gavel"></i>
                    Start Judging!
                </a>
            </div>
            
            <!-- State: Not logged in (show account creation form) -->
            <div id="createAccountState" class="hidden">
                <!-- Message prompting account creation -->
                <div class="bg-yellow-900/30 border border-yellow-500/30 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6 text-left">
                    <p class="text-yellow-200 text-xs sm:text-sm flex items-start gap-2">
                        <i class="fas fa-exclamation-triangle mt-0.5 flex-shrink-0"></i>
                        <span><strong>Create an account</strong> to keep your purchase! Without an account, you'll lose access if you clear your browser data.</span>
                    </p>
                </div>
                
                <!-- Account creation form -->
                <form id="createAccountForm" class="space-y-3 sm:space-y-4 text-left mb-4 sm:mb-6">
                    <div>
                        <label for="email" class="block text-xs font-bold text-gray-500 uppercase mb-1 sm:mb-2">Email</label>
                        <input type="email" id="email" required placeholder="you@example.com" autocomplete="email"
                            class="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 sm:p-4 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition placeholder-gray-500 text-base">
                    </div>
                    <div>
                        <label for="password" class="block text-xs font-bold text-gray-500 uppercase mb-1 sm:mb-2">Password</label>
                        <input type="password" id="password" required placeholder="Min 6 characters" minlength="6" autocomplete="new-password"
                            class="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 sm:p-4 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition placeholder-gray-500 text-base">
                    </div>
                    <div>
                        <label for="confirmPassword" class="block text-xs font-bold text-gray-500 uppercase mb-1 sm:mb-2">Confirm Password</label>
                        <input type="password" id="confirmPassword" required placeholder="Confirm password" minlength="6" autocomplete="new-password"
                            class="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 sm:p-4 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition placeholder-gray-500 text-base">
                    </div>
                    
                    <div id="formError" class="hidden text-red-400 text-sm text-center p-2 bg-red-900/30 rounded"></div>
                    
                    <button type="submit" id="createAccountBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 sm:py-4 rounded-xl text-base sm:text-lg transition flex items-center justify-center gap-2">
                        <i class="fas fa-user-plus"></i>
                        Create Account & Save Purchase
                    </button>
                </form>
                
                <!-- Already have account? Login -->
                <div class="text-center mb-4">
                    <p class="text-gray-400 text-xs sm:text-sm mb-2">Already have an account?</p>
                    <button onclick="showLoginForm()" class="text-green-400 hover:text-green-300 font-medium text-sm">
                        Log in to link this purchase
                    </button>
                </div>
                
                <!-- Login form (hidden by default) -->
                <form id="loginForm" class="hidden space-y-3 sm:space-y-4 text-left mb-4 sm:mb-6">
                    <div>
                        <label for="loginEmail" class="block text-xs font-bold text-gray-500 uppercase mb-1 sm:mb-2">Email</label>
                        <input type="email" id="loginEmail" required placeholder="you@example.com" autocomplete="email"
                            class="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 sm:p-4 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition placeholder-gray-500 text-base">
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-xs font-bold text-gray-500 uppercase mb-1 sm:mb-2">Password</label>
                        <input type="password" id="loginPassword" required placeholder="Your password" autocomplete="current-password"
                            class="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 sm:p-4 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition placeholder-gray-500 text-base">
                    </div>
                    
                    <div id="loginFormError" class="hidden text-red-400 text-sm text-center p-2 bg-red-900/30 rounded"></div>
                    
                    <button type="submit" id="loginBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 sm:py-4 rounded-xl text-base sm:text-lg transition flex items-center justify-center gap-2">
                        <i class="fas fa-sign-in-alt"></i>
                        Log In & Save Purchase
                    </button>
                    
                    <button type="button" onclick="showSignupForm()" class="w-full text-gray-400 hover:text-white text-sm py-2">
                        Back to Create Account
                    </button>
                </form>
                
                <!-- Skip option (not recommended) -->
                <div class="border-t border-gray-700 pt-4">
                    <button onclick="skipAccountCreation()" class="text-gray-500 hover:text-gray-400 text-xs sm:text-sm">
                        Skip for now (not recommended - purchase may be lost)
                    </button>
                </div>
            </div>
            
            <!-- State: Purchase saved successfully -->
            <div id="successState" class="hidden">
                <p class="text-gray-300 text-base sm:text-lg mb-4 sm:mb-6">
                    <i class="fas fa-check-circle text-green-400 mr-2"></i>
                    Your purchase has been saved to your account!
                </p>
                
                <a href="/" class="inline-flex items-center justify-center gap-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 sm:py-4 px-6 sm:px-8 rounded-xl text-base sm:text-lg transition">
                    <i class="fas fa-gavel"></i>
                    Start Judging!
                </a>
                
                <p class="text-gray-500 text-xs sm:text-sm mt-4">
                    <i class="fas fa-lock mr-1"></i>
                    Your premium access is now permanently saved
                </p>
            </div>
            
        </div>
        
        <!-- Footer link -->
        <div class="text-center mt-4 sm:mt-6">
            <a href="/" class="text-gray-400 hover:text-white text-sm">
                <i class="fas fa-home mr-1"></i> Back to Home
            </a>
        </div>
    </div>
    
    <script>
    /**
     * Success page handler with account creation requirement
     * 
     * This page is loaded after a successful Stripe checkout.
     * It requires users to create an account (or log in) to save their purchase.
     * The purchase is then stored in the database linked to their user account.
     */
    (function() {
        const API_BASE = window.location.origin;
        const UNLOCKED_KEY = 'unlockedJudgeIds';
        const ALL_ACCESS_KEY = 'hasAllJudgeAccess';
        const PENDING_PURCHASE_KEY = 'pendingPurchase';
        
        // Parse query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');
        const judgeId = urlParams.get('judgeId');
        const stripeSessionId = urlParams.get('session_id');
        
        // Elements
        const accessDetails = document.getElementById('accessDetails');
        const loggedInState = document.getElementById('loggedInState');
        const createAccountState = document.getElementById('createAccountState');
        const successState = document.getElementById('successState');
        const savingMessage = document.getElementById('savingMessage');
        const startJudgingBtn = document.getElementById('startJudgingBtn');
        
        // Check if user is already logged in
        const accessToken = localStorage.getItem('accessToken');
        
        // Display what was purchased
        function displayPurchaseDetails() {
            if (mode === 'single' && judgeId) {
                accessDetails.textContent = `Judge "${judgeId}" unlocked`;
            } else if (mode === 'subscription') {
                accessDetails.textContent = 'All judges subscription activated';
            } else {
                accessDetails.textContent = 'Payment confirmed';
            }
        }
        
        // Store purchase data for later saving
        function storePendingPurchase() {
            const pendingPurchase = {
                purchaseType: mode,
                judgeId: mode === 'single' ? judgeId : null,
                stripeSessionId: stripeSessionId,
                timestamp: Date.now()
            };
            localStorage.setItem(PENDING_PURCHASE_KEY, JSON.stringify(pendingPurchase));
        }
        
        // Grant temporary local access (in case account creation fails later)
        function grantLocalAccess() {
            if (mode === 'single' && judgeId) {
                const unlockedJudges = safeParseArray(localStorage.getItem(UNLOCKED_KEY), []);
                if (!unlockedJudges.includes(judgeId)) {
                    unlockedJudges.push(judgeId);
                    localStorage.setItem(UNLOCKED_KEY, JSON.stringify(unlockedJudges));
                }
            } else if (mode === 'subscription') {
                localStorage.setItem(ALL_ACCESS_KEY, 'true');
            }
        }
        
        // Helper to safely parse JSON array
        function safeParseArray(value, fallback = []) {
            if (!value) return fallback;
            try {
                const parsed = JSON.parse(value);
                return Array.isArray(parsed) ? parsed : fallback;
            } catch (e) {
                return fallback;
            }
        }
        
        // Save purchase to server
        async function savePurchaseToServer(token) {
            try {
                const response = await fetch(`${API_BASE}/api/purchases/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        purchaseType: mode,
                        judgeId: mode === 'single' ? judgeId : null,
                        stripeSessionId: stripeSessionId
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to save purchase');
                }
                
                // Clear pending purchase from localStorage
                localStorage.removeItem(PENDING_PURCHASE_KEY);
                
                return { success: true, data };
            } catch (error) {
                console.error('Failed to save purchase:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Handle signup
        async function handleSignup(email, password) {
            const response = await fetch(`${API_BASE}/api/auth/signup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Signup failed');
            }
            
            if (data.access_token) {
                localStorage.setItem('accessToken', data.access_token);
                return data.access_token;
            } else {
                throw new Error('Please check your email to confirm your account, then log in');
            }
        }
        
        // Handle login
        async function handleLogin(email, password) {
            const response = await fetch(`${API_BASE}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Login failed');
            }
            
            localStorage.setItem('accessToken', data.access_token);
            return data.access_token;
        }
        
        // Show success state
        function showSuccess() {
            loggedInState.classList.add('hidden');
            createAccountState.classList.add('hidden');
            successState.classList.remove('hidden');
        }
        
        // Show error in form
        function showFormError(formId, message) {
            const errorEl = document.getElementById(formId);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }
        }
        
        // Initialize page
        displayPurchaseDetails();
        storePendingPurchase();
        grantLocalAccess(); // Grant local access as backup
        
        if (accessToken) {
            // User is already logged in - auto-save purchase
            loggedInState.classList.remove('hidden');
            
            savePurchaseToServer(accessToken).then(result => {
                if (result.success) {
                    savingMessage.innerHTML = '<i class="fas fa-check-circle text-green-400 mr-2"></i> Purchase saved to your account!';
                    startJudgingBtn.classList.remove('hidden');
                } else {
                    savingMessage.innerHTML = `<span class="text-yellow-400"><i class="fas fa-exclamation-triangle mr-2"></i> ${result.error}. Your local access is still active.</span>`;
                    startJudgingBtn.classList.remove('hidden');
                }
            });
        } else {
            // User not logged in - show account creation form
            createAccountState.classList.remove('hidden');
        }
        
        // Form event listeners
        document.getElementById('createAccountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const btn = document.getElementById('createAccountBtn');
            
            // Clear previous errors
            document.getElementById('formError').classList.add('hidden');
            
            // Validate passwords match
            if (password !== confirmPassword) {
                showFormError('formError', 'Passwords do not match');
                return;
            }
            
            // Disable button and show loading
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Creating account...';
            
            try {
                // Create account
                const token = await handleSignup(email, password);
                
                // Save purchase to server
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving purchase...';
                await savePurchaseToServer(token);
                
                // Show success
                showSuccess();
            } catch (error) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-user-plus mr-2"></i> Create Account & Save Purchase';
                showFormError('formError', error.message);
            }
        });
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            
            // Clear previous errors
            document.getElementById('loginFormError').classList.add('hidden');
            
            // Disable button and show loading
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Logging in...';
            
            try {
                // Log in
                const token = await handleLogin(email, password);
                
                // Save purchase to server
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving purchase...';
                await savePurchaseToServer(token);
                
                // Show success
                showSuccess();
            } catch (error) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i> Log In & Save Purchase';
                showFormError('loginFormError', error.message);
            }
        });
        
        // Toggle between signup and login forms
        window.showLoginForm = function() {
            document.getElementById('createAccountForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        };
        
        window.showSignupForm = function() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('createAccountForm').classList.remove('hidden');
        };
        
        // Skip account creation (uses local storage only)
        window.skipAccountCreation = function() {
            // Access is already granted locally, just redirect
            window.location.href = '/';
        };
    })();
    </script>
    
</body>
</html>
