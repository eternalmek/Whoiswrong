<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account ‚Äì WhoIsWrong.io</title>
    <meta name="description" content="Manage your WhoIsWrong.io account, privacy, and friends.">

    <!-- Theme Color -->
    <meta name="theme-color" content="#0a0a0a">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öñÔ∏è</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['Oswald', 'sans-serif'],
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand': {
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: white;
            overflow-x: hidden;
        }

        h1, h2, h3, .font-display {
            font-family: 'Oswald', sans-serif;
        }

        .glass-panel {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        @media (max-width: 640px) {
            button, input, textarea { min-height: 44px; font-size: 16px !important; }
        }
    </style>
</head>
<body class="min-h-screen">
    <nav class="fixed top-0 left-0 right-0 z-50 glass-panel">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <a href="/" class="flex items-center gap-2">
                    <span class="text-xl sm:text-2xl">‚öñÔ∏è</span>
                    <span class="font-display text-lg sm:text-xl font-bold">
                        Who Is <span class="text-red-500">Wrong?</span>
                    </span>
                </a>
                <div class="flex items-center gap-2 sm:gap-3">
                    <a href="/" class="text-gray-400 hover:text-white transition text-sm flex items-center gap-1">
                        <i class="fas fa-gavel"></i> <span class="hidden sm:inline">Judge</span>
                    </a>
                    <button data-action="logout" class="text-gray-400 hover:text-red-400 transition text-sm flex items-center gap-1">
                        <i class="fas fa-sign-out-alt"></i> <span class="hidden sm:inline">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div id="loadingState" data-section="account-loading" class="pt-20 sm:pt-24 pb-12 sm:pb-16 px-4 text-center">
        <div class="max-w-md mx-auto">
            <div class="animate-spin text-4xl mb-4">‚öñÔ∏è</div>
            <p class="text-gray-400 text-sm sm:text-base">Loading your account...</p>
        </div>
    </div>

    <div id="loginRequired" data-section="login-required" class="hidden pt-20 sm:pt-24 pb-12 sm:pb-16 px-4">
        <div class="max-w-md mx-auto text-center">
            <div class="glass-panel p-6 sm:p-8 rounded-2xl">
                <div class="text-5xl sm:text-6xl mb-3 sm:mb-4">üîí</div>
                <h1 class="font-display text-2xl sm:text-3xl font-bold mb-3 sm:mb-4">Login Required</h1>
                <p class="text-gray-400 text-sm sm:text-base mb-4 sm:mb-6">You need to be logged in to access your account.</p>
                <a href="/login.html" data-action="go-login" class="inline-block bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition">
                    Go to Login
                </a>
            </div>
        </div>
    </div>

    <div id="accountError" data-section="account-error" class="hidden pt-20 sm:pt-24 pb-12 sm:pb-16 px-4">
        <div class="max-w-md mx-auto text-center">
            <div class="glass-panel p-6 sm:p-8 rounded-2xl">
                <div class="text-5xl sm:text-6xl mb-3 sm:mb-4">‚ö†Ô∏è</div>
                <h1 class="font-display text-2xl sm:text-3xl font-bold mb-3 sm:mb-4">Account Unavailable</h1>
                <p id="accountErrorMessage" class="text-gray-400 text-sm sm:text-base mb-4 sm:mb-6">
                    Something went wrong while loading your account. Please try again.
                </p>
                <button data-action="retry-account" class="inline-block bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition">
                    Retry
                </button>
            </div>
        </div>
    </div>

    <main id="accountContent" data-section="account-main" class="hidden pt-20 sm:pt-24 pb-16 px-4 fade-in">
        <div class="max-w-5xl mx-auto">
            <header class="text-center mb-8 sm:mb-10">
                <h1 class="font-display text-3xl sm:text-4xl font-bold mb-2">My Account</h1>
                <p class="text-gray-400 text-sm sm:text-base">Manage your profile, privacy, and friends.</p>
            </header>

            <div class="glass-panel rounded-2xl p-4 sm:p-6 mb-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-full bg-gray-800 flex items-center justify-center text-2xl" id="avatarPreview">üßë</div>
                        <div>
                            <div class="text-sm text-gray-400" id="emailPreview" data-field="email"></div>
                            <div class="text-xl font-bold" id="displayNamePreview">Loading...</div>
                            <div class="text-gray-400 text-sm" id="usernamePreview"></div>
                        </div>
                    </div>
                    <div class="flex gap-3 text-center">
                        <div>
                            <div class="text-xl font-bold" id="statDebates" data-field="debates-count">0</div>
                            <div class="text-xs text-gray-400">Debates</div>
                        </div>
                        <div>
                            <div class="text-xl font-bold" id="statFriends">0</div>
                            <div class="text-xs text-gray-400">Friends</div>
                        </div>
                        <div>
                            <div class="text-xl font-bold" id="statJudges">0</div>
                            <div class="text-xs text-gray-400">Judges</div>
                        </div>
                        <div>
                            <div class="text-xl font-bold" data-field="purchases-count">0</div>
                            <div class="text-xs text-gray-400">Purchases</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-6" id="tabButtons">
                <button data-tab="overview" class="tab-btn bg-red-600 text-white rounded-xl py-2 text-sm font-semibold">Overview</button>
                <button data-tab="profile" class="tab-btn bg-gray-800 hover:bg-gray-700 rounded-xl py-2 text-sm font-semibold">Profile</button>
                <button data-tab="friends" class="tab-btn bg-gray-800 hover:bg-gray-700 rounded-xl py-2 text-sm font-semibold">Friends</button>
                <button data-tab="security" class="tab-btn bg-gray-800 hover:bg-gray-700 rounded-xl py-2 text-sm font-semibold">Security</button>
            </div>

            <section id="tab-overview" class="tab-panel space-y-6">
                <div class="grid gap-4 lg:grid-cols-2">
                    <div class="glass-panel p-4 sm:p-6 rounded-2xl space-y-4">
                        <div class="flex items-center gap-2 text-lg font-display font-bold">
                            <i class="fas fa-chart-line text-red-500"></i> Account Overview
                        </div>
                            <div class="grid sm:grid-cols-2 gap-3 text-sm text-gray-300">
                                <div>
                                    <div class="text-gray-500 uppercase text-xs">Email</div>
                                    <div id="overviewEmail" data-field="email" class="break-all"></div>
                                </div>
                                <div>
                                    <div class="text-gray-500 uppercase text-xs">Created</div>
                                    <div id="overviewCreated" data-field="created_at">-</div>
                                </div>
                            <div>
                                <div class="text-gray-500 uppercase text-xs">Profile Visibility</div>
                                <div id="overviewVisibility">-</div>
                            </div>
                            <div>
                                <div class="text-gray-500 uppercase text-xs">Friend Requests</div>
                                <div id="overviewRequests">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-panel p-4 sm:p-6 rounded-2xl">
                        <div class="flex items-center gap-2 text-lg font-display font-bold mb-3">
                            <i class="fas fa-users text-red-500"></i> Friends' Latest Debates
                        </div>
                        <div id="friendsDebates" class="space-y-3 text-sm text-gray-300">
                            <div class="text-gray-500">No friend activity yet.</div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-4 sm:p-6 rounded-2xl">
                    <div class="flex items-center gap-2 text-lg font-display font-bold mb-3">
                        <i class="fas fa-history text-red-500"></i> My Verdicts
                    </div>
                    <div id="historyList" class="space-y-3"></div>
                    <div id="noHistory" class="hidden text-center text-gray-400 py-6 sm:py-8">
                        <div class="text-3xl sm:text-4xl mb-3 sm:mb-4">üìú</div>
                        <p class="text-sm sm:text-base">You haven't judged any battles yet!</p>
                        <a href="/" class="inline-block mt-3 sm:mt-4 text-red-400 hover:text-red-300 text-sm">Start judging now <i class="fas fa-arrow-right ml-1"></i></a>
                    </div>
                </div>
            </section>

            <section id="tab-profile" class="tab-panel hidden space-y-6">
                <div class="glass-panel p-4 sm:p-6 rounded-2xl space-y-4">
                    <div class="flex items-center gap-2 text-lg font-display font-bold">
                        <i class="fas fa-user text-red-500"></i> Profile Settings
                    </div>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Display Name</label>
                            <input id="displayNameInput" type="text" maxlength="120" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 transition placeholder-gray-600" placeholder="How should we show you?">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Username</label>
                            <input id="usernameInput" type="text" maxlength="20" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 transition placeholder-gray-600" placeholder="user_name">
                            <div id="usernameHint" class="text-xs mt-1 text-gray-500">3-20 characters, letters/numbers/underscores only.</div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Avatar URL</label>
                            <input id="avatarInput" type="url" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 transition placeholder-gray-600" placeholder="https://...">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Country</label>
                            <input id="countryInput" type="text" maxlength="80" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 transition placeholder-gray-600" placeholder="Country or region">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Bio</label>
                        <textarea id="bioInput" rows="3" maxlength="500" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 transition placeholder-gray-600" placeholder="Tell the world about you (keep it classy)"></textarea>
                    </div>
                    <div class="grid sm:grid-cols-2 gap-4 text-sm">
                        <label class="flex items-center gap-3 bg-gray-900/50 p-3 rounded-lg border border-gray-800">
                            <input id="publicToggle" type="checkbox" class="h-4 w-4 text-red-500 focus:ring-red-500 rounded">
                            <div>
                                <div class="font-semibold">Public profile</div>
                                <div class="text-gray-400 text-xs">Allow others to view your profile card.</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 bg-gray-900/50 p-3 rounded-lg border border-gray-800">
                            <input id="requestsToggle" type="checkbox" class="h-4 w-4 text-red-500 focus:ring-red-500 rounded">
                            <div>
                                <div class="font-semibold">Allow friend requests</div>
                                <div class="text-gray-400 text-xs">Let people send you friend requests.</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 bg-gray-900/50 p-3 rounded-lg border border-gray-800">
                            <input id="wallToggle" type="checkbox" class="h-4 w-4 text-red-500 focus:ring-red-500 rounded">
                            <div>
                                <div class="font-semibold">Show debates on wall</div>
                                <div class="text-gray-400 text-xs">Share debates with friends.</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 bg-gray-900/50 p-3 rounded-lg border border-gray-800">
                            <input id="notificationsToggle" type="checkbox" class="h-4 w-4 text-red-500 focus:ring-red-500 rounded">
                            <div>
                                <div class="font-semibold">Notifications</div>
                                <div class="text-gray-400 text-xs">Save preference for future alerts.</div>
                            </div>
                        </label>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                        <div id="profileStatus" class="text-sm text-gray-400"></div>
                        <button id="saveProfileBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-xl transition text-sm">Save Changes</button>
                    </div>
                </div>
            </section>

            <section id="tab-friends" class="tab-panel hidden space-y-6">
                <div class="glass-panel p-4 sm:p-6 rounded-2xl space-y-4">
                    <div class="flex items-center gap-2 text-lg font-display font-bold">
                        <i class="fas fa-user-friends text-red-500"></i> Find Friends
                    </div>
                    <div class="relative">
                        <input id="searchInput" type="text" placeholder="Search by username or display name" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 transition placeholder-gray-600">
                        <i class="fas fa-search absolute right-3 top-3 text-gray-500"></i>
                    </div>
                    <div id="searchResults" class="space-y-3 text-sm"></div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div class="glass-panel p-4 sm:p-6 rounded-2xl">
                        <div class="flex items-center gap-2 text-lg font-display font-bold mb-3">
                            <i class="fas fa-inbox text-red-500"></i> Incoming Requests
                        </div>
                        <div id="incomingList" class="space-y-3 text-sm text-gray-200"></div>
                    </div>
                    <div class="glass-panel p-4 sm:p-6 rounded-2xl">
                        <div class="flex items-center gap-2 text-lg font-display font-bold mb-3">
                            <i class="fas fa-paper-plane text-red-500"></i> Outgoing Requests
                        </div>
                        <div id="outgoingList" class="space-y-3 text-sm text-gray-200"></div>
                    </div>
                </div>

                <div class="glass-panel p-4 sm:p-6 rounded-2xl">
                    <div class="flex items-center gap-2 text-lg font-display font-bold mb-3">
                        <i class="fas fa-heart text-red-500"></i> Friends
                    </div>
                    <div id="friendsList" class="space-y-3 text-sm text-gray-200"></div>
                </div>
            </section>

            <section id="tab-security" class="tab-panel hidden space-y-6">
                <div class="glass-panel p-4 sm:p-6 rounded-2xl space-y-4">
                    <div class="flex items-center gap-2 text-lg font-display font-bold">
                        <i class="fas fa-shield-alt text-red-500"></i> Security
                    </div>
                        <div class="grid sm:grid-cols-2 gap-4 text-sm">
                            <div class="bg-gray-900/40 p-3 rounded-lg">
                                <div class="text-gray-500 uppercase text-xs">Email</div>
                                <div id="securityEmail" data-field="email" class="break-all"></div>
                            </div>
                        <div class="bg-gray-900/40 p-3 rounded-lg">
                            <div class="text-gray-500 uppercase text-xs">Email Verified</div>
                            <div id="securityVerified">-</div>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button data-action="logout" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-5 rounded-xl transition text-sm flex items-center gap-2">
                            <i class="fas fa-sign-out-alt"></i> Log out
                        </button>
                        <button data-action="open-delete-modal" class="bg-red-900/50 hover:bg-red-800 text-red-300 hover:text-white font-bold py-3 px-5 rounded-xl transition text-sm border border-red-800 flex items-center gap-2">
                            <i class="fas fa-trash"></i> Delete my account
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="deleteModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" data-action="close-delete-modal"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="glass-panel p-8 rounded-2xl w-full max-w-md relative z-10 border border-red-500/50">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="font-display text-2xl font-bold text-red-400">Delete Account?</h3>
                    <p class="text-gray-400 text-sm mt-2">This action cannot be undone. All your data will be permanently deleted.</p>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Type "DELETE" to confirm</label>
                    <input type="text" id="deleteConfirmInput" placeholder="DELETE" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 transition placeholder-gray-600">
                </div>

                <div id="deleteError" class="hidden text-red-400 text-sm text-center p-2 bg-red-900/30 rounded mb-4"></div>

                <div class="flex gap-3">
                    <button data-action="close-delete-modal" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition">Cancel</button>
                    <button data-action="delete-account" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition">Delete Forever</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50 flex items-center gap-3">
        <i id="toastIcon" class="fas fa-check-circle text-green-400"></i>
        <span id="toastMessage">Success!</span>
    </div>


    <script src="/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sections = {
                loading: document.querySelector('[data-section="account-loading"]'),
                login: document.querySelector('[data-section="login-required"]'),
                error: document.querySelector('[data-section="account-error"]'),
                account: document.querySelector('[data-section="account-main"]'),
            };

            const accountErrorMessage = document.getElementById('accountErrorMessage');
            const deleteModal = document.getElementById('deleteModal');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            let accessToken = null;
            let currentProfile = null;

            function setErrorMessage(message) {
                if (accountErrorMessage && message) {
                    accountErrorMessage.textContent = message;
                }
            }

            function showOnly(section) {
                Object.values(sections).forEach((el) => {
                    if (!el) return;
                    const isActive = el === section;
                    el.style.display = isActive ? 'block' : 'none';
                    el.classList.toggle('hidden', !isActive);
                });
            }

            function setField(name, value) {
                const text = value ?? '-';
                document.querySelectorAll(`[data-field="${name}"]`).forEach((el) => {
                    el.textContent = text;
                });
            }

            function showToast(message, type = 'success') {
                if (!toast || !toastMessage || !toastIcon) return;
                toastMessage.textContent = message;
                toastIcon.className =
                    type === 'error'
                        ? 'fas fa-exclamation-circle text-red-400'
                        : 'fas fa-check-circle text-green-400';
                toast.classList.remove('hidden');
                toast.style.opacity = 1;
                setTimeout(() => {
                    toast.style.opacity = 0;
                    setTimeout(() => toast.classList.add('hidden'), 200);
                }, 2400);
            }

            async function apiFetch(path, options = {}) {
                if (!accessToken) {
                    const session = await window.authClient.requireSession({ redirectTo: '/login.html' });
                    accessToken = session?.accessToken;
                }

                try {
                    const response = await fetch(path, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            ...(options.headers || {}),
                            Authorization: `Bearer ${accessToken}`,
                        },
                    });

                    const data = await response.json().catch(() => ({}));
                    if (response.status === 401) {
                        const error = new Error(data.error || 'Please log in again.');
                        error.status = response.status;
                        window.authClient.logoutUser({ redirectTo: '/login.html' });
                        throw error;
                    }

                    if (!response.ok) {
                        const error = new Error(data.error || 'Request failed. Please try again.');
                        error.status = response.status;
                        throw error;
                    }

                    return data;
                } catch (err) {
                    if (!err?.status) {
                        err = Object.assign(new Error('Network error. Please retry.'), err || {});
                    }
                    throw err;
                }
            }

            function formatDate(value) {
                if (!value) return '-';
                const date = new Date(value);
                return Number.isNaN(date.getTime()) ? '-' : date.toLocaleString();
            }

            function profileCompleteness(profile) {
                const fields = ['display_name', 'username', 'avatar_url', 'bio', 'country'];
                const filled = fields.filter((key) => !!profile?.[key]).length;
                return Math.round((filled / fields.length) * 100);
            }

            function renderHistory(items = []) {
                const list = document.getElementById('historyList');
                const empty = document.getElementById('noHistory');
                if (!list || !empty) return;

                list.innerHTML = '';
                if (!items.length) {
                    empty.classList.remove('hidden');
                    return;
                }

                empty.classList.add('hidden');
                items.forEach((item) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'glass-panel p-3 sm:p-4 rounded-xl flex flex-col gap-2 border border-gray-800';
                    wrapper.innerHTML = `
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                            <div>
                                <div class="text-sm text-gray-400">${new Date(item.created_at).toLocaleString()}</div>
                                <div class="font-semibold">${item.context || item.question_text || 'Debate'}</div>
                                <div class="text-gray-400 text-sm">${item.option_a || ''} vs ${item.option_b || ''}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs uppercase text-gray-500">You picked</div>
                                <div class="font-semibold text-red-400">${item.user_side || '‚Äî'}</div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 text-sm">
                            <button class="share-btn bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg" data-id="${item.id}">Share</button>
                            <a class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded-lg" href="/debate/${item.id}" target="_blank" rel="noopener">Open</a>
                        </div>
                    `;
                    list.appendChild(wrapper);
                });

                list.querySelectorAll('.share-btn').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.id;
                        const url = `${window.location.origin}/debate/${id}`;
                        navigator.clipboard
                            .writeText(`I just judged a debate on Whoiswrong.io ‚Äî check it out: ${url}`)
                            .then(() => showToast('Link copied!'))
                            .catch(() => showToast('Copy failed. Share manually!', 'error'));
                    });
                });
            }

            function renderFriends(data) {
                const incomingList = document.getElementById('incomingList');
                const outgoingList = document.getElementById('outgoingList');
                const friendsList = document.getElementById('friendsList');
                if (!incomingList || !outgoingList || !friendsList) return;

                const renderRow = (item, actions = []) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-gray-900/40 p-3 rounded-lg border border-gray-800';
                    div.innerHTML = `
                        <div>
                            <div class="font-semibold">${item.other_user?.display_name || 'Unknown'}</div>
                            <div class="text-xs text-gray-400">${item.other_user?.username || item.other_user?.id || ''}</div>
                        </div>
                        <div class="flex gap-2"></div>
                    `;
                    const btnWrap = div.querySelector('div:last-child');
                    actions.forEach(({ label, action, tone }) => {
                        const b = document.createElement('button');
                        b.className = `${tone === 'danger' ? 'bg-red-700 hover:bg-red-800' : 'bg-gray-800 hover:bg-gray-700'} text-white text-xs px-3 py-2 rounded-lg`;
                        b.textContent = label;
                        b.addEventListener('click', () => action(item));
                        btnWrap.appendChild(b);
                    });
                    return div;
                };

                incomingList.innerHTML = '';
                outgoingList.innerHTML = '';
                friendsList.innerHTML = '';

                (data.incoming || []).forEach((item) => {
                    incomingList.appendChild(
                        renderRow(item, [
                            { label: 'Accept', action: () => respondFriend(item.id, 'accept') },
                            { label: 'Reject', action: () => respondFriend(item.id, 'decline'), tone: 'danger' },
                        ])
                    );
                });

                (data.outgoing || []).forEach((item) => {
                    outgoingList.appendChild(
                        renderRow(item, [{ label: 'Cancel', action: () => cancelFriend(item.id), tone: 'danger' }])
                    );
                });

                (data.friends || []).forEach((item) => {
                    friendsList.appendChild(
                        renderRow(item, [
                            { label: 'Remove', action: () => removeFriend(item.id), tone: 'danger' },
                        ])
                    );
                });
            }

            async function loadFriends() {
                try {
                    const data = await apiFetch('/api/account/friends');
                    renderFriends(data);
                    setField('friends-count', data.friends?.length || 0);
                    setField('requests-count', data.incoming?.length || 0);
                } catch (err) {
                    console.error('Failed to load friends', err);
                }
            }

            async function loadNotifications() {
                const container = document.getElementById('friendsDebates');
                if (!container) return;
                const notifBadge = document.getElementById('overviewRequests');
                try {
                    const { notifications = [], friendsDebates = [] } = await apiFetch('/api/account/notifications');
                    container.innerHTML = '';
                    if (!friendsDebates.length) {
                        container.innerHTML = '<div class="text-gray-500">No friend activity yet.</div>';
                    } else {
                        friendsDebates.forEach((debate) => {
                            const el = document.createElement('div');
                            el.className = 'bg-gray-900/50 p-3 rounded-lg border border-gray-800';
                            el.innerHTML = `
                                <div class="font-semibold">${debate.profile?.display_name || 'Friend'} judged</div>
                                <div class="text-sm text-gray-400">${debate.context || debate.question_text || ''}</div>
                                <div class="text-xs text-gray-500">${new Date(debate.created_at).toLocaleString()}</div>
                            `;
                            container.appendChild(el);
                        });
                    }

                    const unread = notifications.filter((n) => !n.read_at).length;
                    if (notifBadge) notifBadge.textContent = unread > 0 ? `${unread} new` : 'Up to date';
                    if (unread > 0) {
                        apiFetch('/api/account/notifications/read', { method: 'POST' }).catch(() => {});
                    }
                } catch (err) {
                    console.warn('Notifications load failed', err);
                }
            }

            async function loadHistory() {
                try {
                    const { items } = await apiFetch('/api/judgements?mine=true&limit=25');
                    renderHistory(items || []);
                } catch (err) {
                    console.error('History load failed', err);
                }
            }

            async function loadProfile() {
                try {
                    showOnly(sections.loading);
                    const session = await window.authClient.requireSession({ redirectTo: '/login.html' });
                    accessToken = session?.accessToken;
                    if (!accessToken) {
                        showOnly(sections.login);
                        return false;
                    }

                    const data = await apiFetch('/api/account/profile');
                    const { profile, stats, auth, warnings } = data;
                    currentProfile = profile;

                    setField('email', auth?.email || profile?.email || '-');
                    setField('created_at', formatDate(profile?.created_at));
                    setField('debates-count', stats?.debates || 0);
                    setField('friends-count', stats?.friends || 0);
                    setField('purchases-count', stats?.unlockedJudges || 0);
                    document.getElementById('statDebates').textContent = stats?.debates ?? 0;
                    document.getElementById('statFriends').textContent = stats?.friends ?? 0;
                    document.getElementById('statJudges').textContent = stats?.unlockedJudges ?? 0;
                    setField('overviewVisibility', profile?.is_public_profile ? 'Public' : 'Private');
                    setField('overviewRequests', profile?.allow_friend_requests ? 'Allowed' : 'Blocked');
                    setField('display_name', profile?.display_name || '');

                    document.getElementById('emailPreview').textContent = auth?.email || profile?.email || '';
                    document.getElementById('displayNamePreview').textContent = profile?.display_name || 'New User';
                    document.getElementById('usernamePreview').textContent = profile?.username ? `@${profile.username}` : '';
                    document.getElementById('avatarPreview').textContent = profile?.avatar_url ? 'üß†' : 'üßë';

                    document.getElementById('displayNameInput').value = profile?.display_name || '';
                    document.getElementById('usernameInput').value = profile?.username || '';
                    document.getElementById('avatarInput').value = profile?.avatar_url || '';
                    document.getElementById('countryInput').value = profile?.country || '';
                    document.getElementById('bioInput').value = profile?.bio || '';
                    document.getElementById('publicToggle').checked = profile?.is_public_profile !== false;
                    document.getElementById('requestsToggle').checked = profile?.allow_friend_requests !== false;
                    document.getElementById('wallToggle').checked = profile?.show_debates_on_wall !== false;
                    document.getElementById('notificationsToggle').checked = profile?.allow_notifications !== false;

                    const progress = profileCompleteness(profile);
                    const bar = document.createElement('div');
                    bar.className = 'w-full bg-gray-800 rounded-full h-2 mt-3';
                    bar.innerHTML = `<div class="bg-red-600 h-2 rounded-full" style="width:${progress}%"></div>`;
                    const status = document.getElementById('profileStatus');
                    status.textContent = `Profile completeness: ${progress}%`;
                    status.appendChild(bar);

                    if (warnings?.length) console.warn('Account warnings', warnings);

                    showOnly(sections.account);
                    return true;
                } catch (err) {
                    console.error('Unable to load account', err);

                    if (err?.status === 401) {
                        showOnly(sections.login);
                        return false;
                    }

                    if (err?.status === 503) {
                        setErrorMessage('Account service is unavailable. Please try again soon.');
                    } else {
                        setErrorMessage(err?.message || 'Could not load your data. Please refresh the page.');
                    }

                    showOnly(sections.error);
                    return false;
                }
            }

            async function saveProfile() {
                const payload = {
                    display_name: document.getElementById('displayNameInput').value,
                    username: document.getElementById('usernameInput').value,
                    avatar_url: document.getElementById('avatarInput').value,
                    country: document.getElementById('countryInput').value,
                    bio: document.getElementById('bioInput').value,
                    is_public_profile: document.getElementById('publicToggle').checked,
                    allow_friend_requests: document.getElementById('requestsToggle').checked,
                    show_debates_on_wall: document.getElementById('wallToggle').checked,
                    allow_notifications: document.getElementById('notificationsToggle').checked,
                };

                const button = document.getElementById('saveProfileBtn');
                const status = document.getElementById('profileStatus');
                button.disabled = true;
                status.textContent = 'Saving...';

                try {
                    const { profile } = await apiFetch('/api/account/profile', {
                        method: 'PUT',
                        body: JSON.stringify(payload),
                    });
                    currentProfile = profile;
                    showToast('Profile updated');
                    await loadProfile();
                } catch (err) {
                    console.error('Profile save failed', err);
                    status.textContent = err.message || 'Could not save changes.';
                } finally {
                    button.disabled = false;
                }
            }

            async function respondFriend(id, action) {
                try {
                    await apiFetch('/api/account/friends/respond', {
                        method: 'POST',
                        body: JSON.stringify({ friendship_id: id, action }),
                    });
                    showToast('Friend request updated');
                    loadFriends();
                } catch (err) {
                    showToast(err.message || 'Unable to update request', 'error');
                }
            }

            async function cancelFriend(id) {
                try {
                    await apiFetch('/api/account/friends/cancel', {
                        method: 'POST',
                        body: JSON.stringify({ friendship_id: id }),
                    });
                    showToast('Request cancelled');
                    loadFriends();
                } catch (err) {
                    showToast(err.message || 'Unable to cancel request', 'error');
                }
            }

            async function removeFriend(id) {
                try {
                    await apiFetch('/api/account/friends/remove', {
                        method: 'POST',
                        body: JSON.stringify({ friendship_id: id }),
                    });
                    showToast('Friend removed');
                    loadFriends();
                } catch (err) {
                    showToast(err.message || 'Unable to remove friend', 'error');
                }
            }

            async function searchUsers(term) {
                const resultsEl = document.getElementById('searchResults');
                if (!resultsEl) return;
                resultsEl.innerHTML = '<div class="text-gray-500 text-sm">Searching...</div>';
                try {
                    const { results } = await apiFetch(`/api/account/search?query=${encodeURIComponent(term)}`);
                    resultsEl.innerHTML = '';
                    if (!results.length) {
                        resultsEl.innerHTML = '<div class="text-gray-500 text-sm">No users found.</div>';
                        return;
                    }

                    results.forEach((user) => {
                        const el = document.createElement('div');
                        el.className = 'flex items-center justify-between bg-gray-900/50 p-3 rounded-lg border border-gray-800';
                        el.innerHTML = `
                            <div>
                                <div class="font-semibold">${user.display_name || 'User'}</div>
                                <div class="text-xs text-gray-400">${user.username || user.id}</div>
                            </div>
                            <button class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-2 rounded-lg">${
                                user.status === 'accepted'
                                    ? 'Friends'
                                    : user.status === 'pending'
                                    ? user.is_requester
                                        ? 'Pending'
                                        : 'Respond'
                                    : 'Add friend'
                            }</button>
                        `;
                        const btn = el.querySelector('button');
                        btn.disabled = user.status === 'accepted' || user.status === 'pending';
                        if (!btn.disabled) {
                            btn.addEventListener('click', async () => {
                                try {
                                    await apiFetch('/api/account/friends/request', {
                                        method: 'POST',
                                        body: JSON.stringify({ receiver_id: user.id }),
                                    });
                                    showToast('Request sent');
                                    loadFriends();
                                    btn.textContent = 'Pending';
                                    btn.disabled = true;
                                } catch (err) {
                                    showToast(err.message || 'Unable to send request', 'error');
                                }
                            });
                        }
                        resultsEl.appendChild(el);
                    });
                } catch (err) {
                    resultsEl.innerHTML = `<div class="text-red-400 text-sm">${err.message || 'Search failed'}</div>`;
                }
            }

            function openDeleteModal() {
                if (deleteModal) {
                    deleteModal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            }

            function closeDeleteModal() {
                if (deleteModal) {
                    deleteModal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            }

            async function handleLogout() {
                window.authClient.logoutUser({ redirectTo: '/' });
            }

            async function handleDeleteAccount() {
                const errorEl = document.getElementById('deleteError');
                const confirmInput = document.getElementById('deleteConfirmInput');
                if (!confirmInput || confirmInput.value !== 'DELETE') {
                    errorEl.textContent = 'Please type DELETE to confirm.';
                    errorEl.classList.remove('hidden');
                    return;
                }

                try {
                    await apiFetch('/api/auth/me', { method: 'DELETE' });
                    showToast('Account deleted');
                    window.authClient.logoutUser({ redirectTo: '/' });
                } catch (err) {
                    errorEl.textContent = err.message || 'Unable to delete account.';
                    errorEl.classList.remove('hidden');
                }
            }

            function setupTabs() {
                const tabButtons = document.querySelectorAll('#tabButtons [data-tab]');
                const panels = document.querySelectorAll('.tab-panel');

                function switchTab(tab) {
                    panels.forEach((panel) => {
                        panel.classList.toggle('hidden', panel.id !== `tab-${tab}`);
                    });

                    tabButtons.forEach((btn) => {
                        const isActive = btn.dataset.tab === tab;
                        btn.classList.toggle('bg-red-600', isActive);
                        btn.classList.toggle('text-white', isActive);
                        btn.classList.toggle('bg-gray-800', !isActive);
                    });
                }

                tabButtons.forEach((btn) => {
                    btn.addEventListener('click', () => switchTab(btn.dataset.tab));
                });

                const initialTab = document.querySelector('#tabButtons [data-tab]');
                switchTab(initialTab?.dataset.tab || 'overview');
            }

            document.querySelectorAll('[data-action="go-login"]').forEach((btn) => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = '/login.html';
                });
            });

            document.querySelectorAll('[data-action="retry-account"]').forEach((btn) => {
                btn.addEventListener('click', loadProfile);
            });

            document.querySelectorAll('[data-action="logout"]').forEach((btn) => {
                btn.addEventListener('click', handleLogout);
            });

            document.querySelectorAll('[data-action="open-delete-modal"]').forEach((btn) => {
                btn.addEventListener('click', openDeleteModal);
            });

            document.querySelectorAll('[data-action="close-delete-modal"]').forEach((btn) => {
                btn.addEventListener('click', closeDeleteModal);
            });

            document.querySelectorAll('[data-action="delete-account"]').forEach((btn) => {
                btn.addEventListener('click', handleDeleteAccount);
            });

            document.getElementById('saveProfileBtn')?.addEventListener('click', saveProfile);

            document.getElementById('searchInput')?.addEventListener('input', (e) => {
                const value = e.target.value.trim();
                if (!value) {
                    document.getElementById('searchResults').innerHTML = '';
                    return;
                }
                searchUsers(value);
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeDeleteModal();
            });

            setupTabs();
            loadProfile().then((ok) => {
                if (ok) {
                    loadHistory();
                    loadFriends();
                    loadNotifications();
                }
            });
        });
    </script>

    <script defer src="https://va.vercel-scripts.com/v1/script.js" data-sdkn="@vercel/analytics" data-sdkv="1.6.0"></script>
</body>
</html>
