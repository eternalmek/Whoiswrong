<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Account ‚Äì WhoIsWrong.io</title>
    <meta name="description" content="View your verdicts, manage your profile, and access your account on WhoIsWrong.io">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#0a0a0a">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öñÔ∏è</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['Oswald', 'sans-serif'],
                        'sans': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: white;
            overflow-x: hidden;
        }
        
        h1, h2, h3, .font-display {
            font-family: 'Oswald', sans-serif;
        }
        
        .glass-panel {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
    <!-- Note: This page has its own auth logic and doesn't need auth.js -->
</head>
<body class="min-h-screen">
    
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass-panel">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <a href="/" class="flex items-center gap-2">
                    <span class="text-xl sm:text-2xl">‚öñÔ∏è</span>
                    <span class="font-display text-lg sm:text-xl font-bold">
                        Who Is <span class="text-red-500">Wrong?</span>
                    </span>
                </a>
                
                <div class="flex items-center gap-3">
                    <!-- Auth Buttons (shown when logged out) -->
                    <div id="authButtons" class="flex items-center gap-2">
                        <a href="/login.html" class="text-gray-400 hover:text-white transition text-sm">Login</a>
                        <a href="/signup.html" class="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1.5 rounded-lg transition">Sign up</a>
                    </div>
                    
                    <!-- User Menu (shown when logged in) -->
                    <div id="userMenu" class="hidden items-center gap-3">
                        <span id="userEmail" class="text-gray-400 text-sm hidden sm:inline"></span>
                        <button onclick="handleLogout()" class="text-gray-400 hover:text-white transition text-sm flex items-center gap-1">
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="hidden sm:inline">Log out</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="pt-20 sm:pt-24 pb-12 sm:pb-16 px-4">
        <div class="max-w-4xl mx-auto">
            
            <!-- Hero Header -->
            <header class="text-center mb-8 sm:mb-12">
                <h1 class="font-display text-4xl sm:text-5xl font-bold mb-3 sm:mb-4 text-red-500">Your Account</h1>
                <p class="text-gray-400 text-base sm:text-lg max-w-2xl mx-auto">Manage your profile, view your debate history, and unlock celebrity judges.</p>
            </header>
            
            <!-- Loading State -->
            <div id="loadingState" class="glass-panel p-8 rounded-2xl text-center">
                <div class="text-4xl mb-4 animate-pulse">‚öñÔ∏è</div>
                <p class="text-gray-400">Loading your account...</p>
            </div>
            
            <!-- Login Prompt (shown when not logged in) -->
            <div id="loginPrompt" class="hidden glass-panel p-6 sm:p-8 rounded-2xl text-center">
                <div class="text-5xl mb-4">üîê</div>
                <h2 class="font-display text-2xl sm:text-3xl font-bold mb-3">Sign In Required</h2>
                <p class="text-gray-400 mb-6">Log in or create an account to access your verdicts, history, and purchased judges.</p>
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <a href="/login.html" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition">
                        <i class="fas fa-sign-in-alt mr-2"></i>Log In
                    </a>
                    <a href="/signup.html" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white font-bold py-3 px-6 rounded-xl transition">
                        <i class="fas fa-user-plus mr-2"></i>Create Account
                    </a>
                </div>
            </div>
            
            <!-- Account Content (shown when logged in) -->
            <div id="accountContent" class="hidden space-y-6">
                
                <!-- Profile Section -->
                <section class="glass-panel p-6 sm:p-8 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <p class="text-red-500 uppercase tracking-wider text-xs font-bold mb-1">Profile</p>
                            <h2 class="font-display text-xl sm:text-2xl font-bold">Your Details</h2>
                        </div>
                        <span id="profilePill" class="text-xs px-3 py-1 rounded-full bg-green-500/20 text-green-300 font-semibold"></span>
                    </div>
                    <form id="profileForm" class="space-y-4">
                        <div>
                            <label for="profileDisplayName" class="block text-xs font-bold text-gray-500 uppercase mb-2">Display Name</label>
                            <input type="text" id="profileDisplayName" class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Your name">
                        </div>
                        <div>
                            <label for="profileUsername" class="block text-xs font-bold text-gray-500 uppercase mb-2">Username</label>
                            <input type="text" id="profileUsername" class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="username" pattern="[A-Za-z0-9_]{3,20}">
                            <p class="text-gray-500 text-xs mt-1">3-20 characters, letters, numbers, underscores only.</p>
                        </div>
                        <button type="submit" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition">
                            Save Profile
                        </button>
                    </form>
                </section>
                
                <!-- Recent Verdicts Section -->
                <section class="glass-panel p-6 sm:p-8 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <p class="text-red-500 uppercase tracking-wider text-xs font-bold mb-1">History</p>
                            <h2 class="font-display text-xl sm:text-2xl font-bold">Recent Verdicts</h2>
                        </div>
                        <a href="/" class="text-red-400 hover:text-red-300 text-sm font-semibold">
                            New Judgement ‚Üí
                        </a>
                    </div>
                    <div id="judgementsFeed" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">Loading your verdicts...</p>
                    </div>
                </section>
                
                <!-- Unlocked Judges Section -->
                <section class="glass-panel p-6 sm:p-8 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <p class="text-red-500 uppercase tracking-wider text-xs font-bold mb-1">Purchases</p>
                            <h2 class="font-display text-xl sm:text-2xl font-bold">Unlocked Judges</h2>
                        </div>
                    </div>
                    <div id="unlockedJudges" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">Loading your purchases...</p>
                    </div>
                </section>
                
                <!-- Account Actions Section -->
                <section class="glass-panel p-6 sm:p-8 rounded-2xl">
                    <div class="mb-6">
                        <p class="text-red-500 uppercase tracking-wider text-xs font-bold mb-1">Session</p>
                        <h2 class="font-display text-xl sm:text-2xl font-bold">Account Actions</h2>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button onclick="handleLogout()" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white font-bold py-3 px-6 rounded-xl transition flex items-center justify-center gap-2">
                            <i class="fas fa-sign-out-alt"></i>
                            Log Out
                        </button>
                    </div>
                    <p class="text-gray-500 text-xs mt-3">Signing out clears your session from this device.</p>
                </section>
                
            </div>
            
            <!-- CTA to homepage -->
            <div class="text-center mt-8">
                <a href="/" class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition">
                    <i class="fas fa-gavel"></i>
                    Start a New Judgement
                </a>
            </div>
            
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="py-6 sm:py-8 px-4 border-t border-gray-800">
        <div class="max-w-6xl mx-auto text-center text-gray-500 text-xs sm:text-sm">
            <p>&copy; 2024 Betterappai. All rights reserved.</p>
            <div class="mt-3 sm:mt-4 flex justify-center gap-4 sm:gap-6">
                <a href="/about.html" class="hover:text-red-400 transition">About</a>
                <a href="/legal.html" class="hover:text-red-400 transition">Legal</a>
                <a href="/" class="hover:text-red-400 transition">Home</a>
            </div>
        </div>
    </footer>
    
    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 z-50 bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 shadow-lg flex items-center gap-3 max-w-sm">
        <i id="toastIcon" class="fas fa-check-circle text-green-400"></i>
        <span id="toastMessage" class="text-sm text-white">Success!</span>
    </div>
    
    <script>
        // Account page JavaScript
        const API_BASE = window.location.origin;
        
        // DOM Elements
        const loadingState = document.getElementById('loadingState');
        const loginPrompt = document.getElementById('loginPrompt');
        const accountContent = document.getElementById('accountContent');
        const authButtons = document.getElementById('authButtons');
        const userMenu = document.getElementById('userMenu');
        const userEmailEl = document.getElementById('userEmail');
        const profileForm = document.getElementById('profileForm');
        const profileDisplayName = document.getElementById('profileDisplayName');
        const profileUsername = document.getElementById('profileUsername');
        const profilePill = document.getElementById('profilePill');
        const judgementsFeed = document.getElementById('judgementsFeed');
        const unlockedJudges = document.getElementById('unlockedJudges');
        
        // Toast function
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            
            if (!toast) return;
            
            toastMessage.innerText = message;
            toastIcon.className = 'fas';
            
            if (type === 'success') {
                toastIcon.classList.add('fa-check-circle', 'text-green-400');
            } else if (type === 'error') {
                toastIcon.classList.add('fa-exclamation-circle', 'text-red-400');
            } else {
                toastIcon.classList.add('fa-info-circle', 'text-blue-400');
            }
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
        
        // Get auth headers
        function getAuthHeaders() {
            const token = localStorage.getItem('accessToken');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }
        
        // Check if logged in
        function isLoggedIn() {
            const token = localStorage.getItem('accessToken');
            return token && token !== 'null' && token !== 'undefined';
        }
        
        // Handle logout
        function handleLogout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('currentUser');
            showToast('Logged out successfully', 'info');
            setTimeout(() => window.location.href = '/', 1000);
        }
        
        // Update auth UI
        function updateAuthUI(isAuthenticated, user = null) {
            if (isAuthenticated) {
                authButtons.classList.add('hidden');
                userMenu.classList.remove('hidden');
                userMenu.classList.add('flex');
                if (user && userEmailEl) {
                    userEmailEl.textContent = user.email || 'Account';
                }
            } else {
                authButtons.classList.remove('hidden');
                userMenu.classList.add('hidden');
            }
        }
        
        // Show appropriate content
        function showContent(state) {
            loadingState.classList.add('hidden');
            loginPrompt.classList.add('hidden');
            accountContent.classList.add('hidden');
            
            if (state === 'loading') {
                loadingState.classList.remove('hidden');
            } else if (state === 'login') {
                loginPrompt.classList.remove('hidden');
            } else if (state === 'account') {
                accountContent.classList.remove('hidden');
            }
        }
        
        // Load account data
        async function loadAccountData() {
            try {
                const response = await fetch(`${API_BASE}/api/account/profile`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load account');
                }
                
                const data = await response.json();
                
                // Populate profile form
                if (data.profile) {
                    profileDisplayName.value = data.profile.display_name || '';
                    profileUsername.value = data.profile.username || '';
                    if (profilePill) {
                        profilePill.textContent = data.profile.username ? `@${data.profile.username}` : 'No username';
                    }
                }
                
                // Load verdicts
                loadVerdicts();
                
                // Load purchases
                loadPurchases();
                
                return data;
            } catch (error) {
                console.error('Failed to load account:', error);
                throw error;
            }
        }
        
        // Load user's verdicts
        async function loadVerdicts() {
            try {
                const response = await fetch(`${API_BASE}/api/judgements?limit=10`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const items = data.items || data.judgements || [];
                    
                    if (items.length === 0) {
                        judgementsFeed.innerHTML = `
                            <div class="text-center py-6">
                                <div class="text-4xl mb-2">üéØ</div>
                                <p class="text-gray-400">No verdicts yet.</p>
                                <a href="/" class="text-red-400 hover:text-red-300 text-sm">Start your first debate ‚Üí</a>
                            </div>
                        `;
                    } else {
                        judgementsFeed.innerHTML = items.map(item => `
                            <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
                                <div class="flex items-start justify-between mb-2">
                                    <p class="text-white font-semibold">${item.context || item.question_text || 'Debate'}</p>
                                    <span class="text-xs text-gray-500">${new Date(item.created_at).toLocaleDateString()}</span>
                                </div>
                                <div class="flex gap-2 text-sm mb-2">
                                    <span class="px-2 py-1 bg-red-500/20 text-red-300 rounded">‚ùå ${item.wrong || item.option_a || 'Side A'}</span>
                                    <span class="px-2 py-1 bg-green-500/20 text-green-300 rounded">‚úÖ ${item.right || item.option_b || 'Side B'}</span>
                                </div>
                                <p class="text-gray-400 text-sm">${item.reason || item.verdict_text || ''}</p>
                            </div>
                        `).join('');
                    }
                } else {
                    judgementsFeed.innerHTML = '<p class="text-gray-500 text-center py-4">Could not load verdicts.</p>';
                }
            } catch (error) {
                console.error('Failed to load verdicts:', error);
                judgementsFeed.innerHTML = '<p class="text-gray-500 text-center py-4">Could not load verdicts.</p>';
            }
        }
        
        // Load user's purchases
        async function loadPurchases() {
            try {
                const response = await fetch(`${API_BASE}/api/purchases`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const judges = data.unlockedJudges || [];
                    const hasAllAccess = data.hasAllAccess || false;
                    
                    if (hasAllAccess) {
                        unlockedJudges.innerHTML = `
                            <div class="bg-gradient-to-r from-red-600/20 to-orange-500/20 border border-red-500/30 rounded-xl p-4 text-center">
                                <div class="text-3xl mb-2">üëë</div>
                                <p class="text-white font-bold">All Access Subscription</p>
                                <p class="text-gray-400 text-sm">You have access to all celebrity judges!</p>
                            </div>
                        `;
                    } else if (judges.length === 0) {
                        unlockedJudges.innerHTML = `
                            <div class="text-center py-6">
                                <div class="text-4xl mb-2">üîí</div>
                                <p class="text-gray-400">No judges unlocked yet.</p>
                                <p class="text-gray-500 text-sm">The default AI judge is always free!</p>
                                <a href="/" class="text-red-400 hover:text-red-300 text-sm">Unlock celebrity judges ‚Üí</a>
                            </div>
                        `;
                    } else {
                        unlockedJudges.innerHTML = `
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                ${judges.map(judgeId => `
                                    <div class="bg-gray-900 border border-gray-800 rounded-xl p-3 text-center">
                                        <div class="text-2xl mb-1">‚≠ê</div>
                                        <p class="text-white text-sm font-semibold">${judgeId}</p>
                                        <span class="text-xs text-green-400">Unlocked</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                } else {
                    unlockedJudges.innerHTML = '<p class="text-gray-500 text-center py-4">Could not load purchases.</p>';
                }
            } catch (error) {
                console.error('Failed to load purchases:', error);
                unlockedJudges.innerHTML = '<p class="text-gray-500 text-center py-4">Could not load purchases.</p>';
            }
        }
        
        // Save profile
        async function saveProfile(e) {
            e.preventDefault();
            
            try {
                const response = await fetch(`${API_BASE}/api/account/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        display_name: profileDisplayName.value,
                        username: profileUsername.value || null
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to save profile');
                }
                
                if (data.profile?.username) {
                    profilePill.textContent = `@${data.profile.username}`;
                }
                
                showToast('Profile saved!', 'success');
            } catch (error) {
                showToast(error.message || 'Failed to save profile', 'error');
            }
        }
        
        // Initialize page
        async function initAccount() {
            showContent('loading');
            
            if (!isLoggedIn()) {
                updateAuthUI(false);
                showContent('login');
                return;
            }
            
            try {
                // Verify token is valid
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    // Try to refresh
                    const refreshToken = localStorage.getItem('refreshToken');
                    if (refreshToken) {
                        const refreshResponse = await fetch(`${API_BASE}/api/auth/refresh`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ refresh_token: refreshToken })
                        });
                        
                        if (refreshResponse.ok) {
                            const refreshData = await refreshResponse.json();
                            if (refreshData.access_token) {
                                localStorage.setItem('accessToken', refreshData.access_token);
                                if (refreshData.refresh_token) {
                                    localStorage.setItem('refreshToken', refreshData.refresh_token);
                                }
                            }
                        } else {
                            throw new Error('Session expired');
                        }
                    } else {
                        throw new Error('Not authenticated');
                    }
                }
                
                const userData = await response.json();
                updateAuthUI(true, userData.user);
                await loadAccountData();
                showContent('account');
                
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                updateAuthUI(false);
                showContent('login');
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initAccount();
            
            if (profileForm) {
                profileForm.addEventListener('submit', saveProfile);
            }
        });
        
        // Expose functions globally
        window.handleLogout = handleLogout;
    </script>
    
    <script defer src="https://va.vercel-scripts.com/v1/script.js" data-sdkn="@vercel/analytics" data-sdkv="1.6.0"></script>
</body>
</html>
